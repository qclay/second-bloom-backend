generator client {
  provider        = "prisma-client-js"
  previewFeatures = []
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

model Auction {
  id            String        @id @default(uuid())
  productId     String
  creatorId     String
  startPrice    Decimal       @db.Decimal(10, 2)
  currentPrice  Decimal       @db.Decimal(10, 2)
  bidIncrement  Decimal       @default(1000) @db.Decimal(10, 2)
  minBidAmount  Decimal       @db.Decimal(10, 2)
  startTime     DateTime      @default(now())
  endTime       DateTime
  durationHours Int           @default(2)
  status        AuctionStatus @default(ACTIVE)
  winnerId      String?
  autoExtend    Boolean       @default(true)
  extendMinutes Int           @default(5)
  views         Int           @default(0)
  totalBids     Int           @default(0)
  version       Int           @default(0)
  lastBidAt     DateTime?
  deletedAt     DateTime?
  deletedBy     String?
  metadata      Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  isActive      Boolean       @default(true)
  creator       User          @relation("AuctionCreator", fields: [creatorId], references: [id])
  product       Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  winner        User?         @relation("AuctionWinner", fields: [winnerId], references: [id])
  bids          Bid[]
  orders        Order[]

  @@index([productId, status])
  @@index([status, endTime])
  @@index([isActive, deletedAt])
  @@index([status, isActive])
  @@index([status, createdAt])
  @@index([creatorId])
  @@index([productId])
  @@index([endTime])
  @@index([deletedAt])
  @@index([lastBidAt])
  @@map("auctions")
}

model Bid {
  id          String    @id @default(uuid())
  auctionId   String
  bidderId    String
  amount      Decimal   @db.Decimal(10, 2)
  isWinning   Boolean   @default(false)
  isRetracted Boolean   @default(false)
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  deletedBy   String?
  isActive    Boolean   @default(true)
  auction     Auction   @relation(fields: [auctionId], references: [id])
  bidder      User      @relation(fields: [bidderId], references: [id])

  @@index([auctionId, createdAt])
  @@index([bidderId])
  @@index([auctionId, bidderId])
  @@index([auctionId, isWinning])
  @@index([auctionId, isRetracted])
  @@index([isActive, deletedAt])
  @@index([createdAt])
  @@index([ipAddress])
  @@map("bids")
}

model Favorite {
  id        String    @id @default(uuid())
  userId    String
  productId String
  createdAt DateTime  @default(now())
  deletedAt DateTime?
  deletedBy String?
  isActive  Boolean   @default(true)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@index([isActive, deletedAt])
  @@map("favorites")
}

model Category {
  id          String     @id @default(uuid())
  name        String     @unique
  slug        String     @unique
  description String?
  imageId     String?
  parentId    String?
  order       Int        @default(0)
  isActive    Boolean    @default(true)
  deletedAt   DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedBy   String?
  image       File?      @relation(fields: [imageId], references: [id])
  parent      Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryTree")
  products    Product[]

  @@index([parentId])
  @@index([slug])
  @@index([isActive, deletedAt])
  @@index([order])
  @@map("categories")
}

model Condition {
  id         String    @id @default(uuid())
  name       String    @db.VarChar(100)
  slug       String    @unique
  createdById String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?
  isActive   Boolean   @default(true)
  createdBy  User?     @relation("ConditionCreator", fields: [createdById], references: [id])
  products   Product[]

  @@index([slug])
  @@index([createdById])
  @@index([isActive, deletedAt])
  @@map("conditions")
}

model Size {
  id         String    @id @default(uuid())
  name       String    @db.VarChar(100)
  slug       String    @unique
  createdById String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?
  isActive   Boolean   @default(true)
  createdBy  User?     @relation("SizeCreator", fields: [createdById], references: [id])
  products   Product[]

  @@index([slug])
  @@index([createdById])
  @@index([isActive, deletedAt])
  @@map("sizes")
}

model File {
  id                 String         @id @default(uuid())
  url                String         @unique
  key                String
  filename           String
  originalName       String
  mimeType           String
  size               Int
  width              Int?
  height             Int?
  fileType           FileType
  entityType         EntityType?
  entityId           String?
  uploadedById       String?
  isPublic           Boolean        @default(true)
  metadata           Json?
  deletedAt          DateTime?
  deletedBy          String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  isActive           Boolean        @default(true)
  categoryImages     Category[]
  uploadedBy         User?          @relation("FileUploader", fields: [uploadedById], references: [id])
  messageAttachments Message[]      @relation("MessageFile")
  productImages      ProductImage[]
  userAvatars        User?          @relation("UserAvatar")

  @@index([url])
  @@index([key])
  @@index([entityType, entityId])
  @@index([uploadedById])
  @@index([fileType])
  @@index([isActive, deletedAt])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("files")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())
  deletedAt DateTime?
  deletedBy String?
  isActive  Boolean          @default(true)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([type])
  @@index([isActive, deletedAt])
  @@map("notifications")
}

model NotificationPreference {
  id                String    @id @default(uuid())
  userId            String    @unique
  auctionEndingSoon Boolean   @default(true)
  auctionEnded      Boolean   @default(true)
  auctionStarted    Boolean   @default(true)
  newBid            Boolean   @default(true)
  outbid            Boolean   @default(true)
  orderConfirmed    Boolean   @default(true)
  orderShipped      Boolean   @default(true)
  orderDelivered    Boolean   @default(true)
  reviewReceived    Boolean   @default(true)
  newMessage        Boolean   @default(true)
  system            Boolean   @default(true)
  pushEnabled       Boolean   @default(true)
  isActive          Boolean   @default(true)
  deletedAt         DateTime?
  deletedBy         String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive, deletedAt])
  @@map("notification_preferences")
}

model Order {
  id                 String         @id @default(uuid())
  orderNumber        String         @unique
  buyerId            String
  productId          String
  auctionId          String?
  amount             Decimal        @db.Decimal(10, 2)
  status             OrderStatus    @default(PENDING)
  paymentStatus      PaymentStatus  @default(PENDING)
  shippingAddress    String?
  notes              String?
  cancelledAt        DateTime?
  cancelledBy        String?
  cancellationReason String?
  shippedAt          DateTime?
  deliveredAt        DateTime?
  deletedAt          DateTime?
  deletedBy          String?
  metadata           Json?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  completedAt        DateTime?
  isActive           Boolean        @default(true)
  conversations      Conversation[]
  auction            Auction?       @relation(fields: [auctionId], references: [id])
  buyer              User           @relation(fields: [buyerId], references: [id])
  product            Product        @relation(fields: [productId], references: [id])

  @@index([buyerId])
  @@index([buyerId, status, createdAt])
  @@index([orderNumber])
  @@index([status])
  @@index([isActive, deletedAt])
  @@index([status, deletedAt])
  @@index([paymentStatus])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([cancelledAt])
  @@index([shippedAt])
  @@map("orders")
}

model Payment {
  id                   String          @id @default(uuid())
  amount               Decimal         @db.Decimal(10, 2)
  method               PaymentMethod
  gateway              PaymentGateway?
  transactionId        String?         @unique
  gatewayTransactionId String?
  gatewayOrderId       String?
  status               PaymentStatus   @default(PENDING)
  paidAt               DateTime?
  webhookData          Json?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  paymentType          PaymentType     @default(PUBLICATION)
  quantity             Int             @default(1)
  userId               String
  deletedAt            DateTime?
  deletedBy            String?
  isActive             Boolean         @default(true)
  user                 User            @relation("PaymentUser", fields: [userId], references: [id])
  products             Product[]       @relation("ProductPublicationPayment")

  @@index([userId])
  @@index([paymentType])
  @@index([userId, paymentType])
  @@index([userId, status])
  @@index([transactionId])
  @@index([gatewayTransactionId])
  @@index([gatewayOrderId])
  @@index([gateway])
  @@index([status])
  @@index([paidAt])
  @@index([isActive, deletedAt])
  @@map("payments")
}

model Product {
  id                   String            @id @default(uuid())
  title                String            @db.VarChar(255)
  slug                 String            @unique
  description          String?
  price                Decimal           @db.Decimal(10, 2)
  currency             String            @default("UZS")
  categoryId           String
  tags                 String[]
  type                 ProductType       @default(FRESH)
  conditionId          String?
  sizeId               String?
  quantity             Int               @default(1)
  status               ProductStatus     @default(ACTIVE)
  isFeatured           Boolean           @default(false)
  views                Int               @default(0)
  region               String?
  city                 String?
  district             String?
  sellerId             String
  deletedAt            DateTime?
  deletedBy            String?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  publicationPaymentId String?
  isActive             Boolean           @default(true)
  auctions             Auction[]
  conversations        Conversation[]
  favorites            Favorite[]
  orders               Order[]
  images               ProductImage[]
  category             Category          @relation(fields: [categoryId], references: [id])
  condition            Condition?        @relation(fields: [conditionId], references: [id])
  size                 Size?             @relation(fields: [sizeId], references: [id])
  publicationPayment   Payment?          @relation("ProductPublicationPayment", fields: [publicationPaymentId], references: [id])
  seller               User              @relation(fields: [sellerId], references: [id])
  reviews              Review[]

  @@index([publicationPaymentId])
  @@index([sellerId])
  @@index([slug])
  @@index([conditionId])
  @@index([sizeId])
  @@index([isActive, deletedAt])
  @@index([status, deletedAt])
  @@index([status, type, categoryId])
  @@index([type, status])
  @@index([categoryId, status])
  @@index([isFeatured, status])
  @@index([region])
  @@index([city])
  @@index([region, city])
  @@index([status, region, city])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("products")
}

model ProductImage {
  id           String    @id @default(uuid())
  productId    String
  fileId       String
  displayOrder Int       @default(0) @map("order")
  createdAt    DateTime  @default(now())
  deletedAt    DateTime?
  deletedBy    String?
  isActive     Boolean   @default(true)
  file         File      @relation(fields: [fileId], references: [id], onDelete: Cascade)
  product      Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, fileId])
  @@index([productId, displayOrder])
  @@index([fileId])
  @@index([isActive, deletedAt])
  @@map("product_images")
}

model Review {
  id           String    @id @default(uuid())
  reviewerId   String
  revieweeId   String
  productId    String?
  orderId      String?
  parentId     String?
  rating       Int       @db.SmallInt
  comment      String?
  isVerified   Boolean   @default(false)
  isReported   Boolean   @default(false)
  reportReason String?
  reportedAt   DateTime?
  helpfulCount Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?
  deletedBy    String?
  isActive     Boolean   @default(true)
  parent       Review?   @relation("ReviewReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies      Review[]  @relation("ReviewReplies")
  product      Product?  @relation(fields: [productId], references: [id])
  reviewee     User      @relation("Reviewee", fields: [revieweeId], references: [id])
  reviewer     User      @relation("Reviewer", fields: [reviewerId], references: [id])

  @@unique([reviewerId, revieweeId, productId])
  @@index([revieweeId])
  @@index([revieweeId, createdAt])
  @@index([productId])
  @@index([productId, rating])
  @@index([productId, createdAt])
  @@index([rating])
  @@index([parentId])
  @@index([isReported])
  @@index([isActive, deletedAt])
  @@index([createdAt])
  @@map("reviews")
}

model User {
  id                     String                  @id @default(uuid())
  countryCode            String?
  phoneNumber            String
  firstName              String?
  lastName               String?
  email                  String?                 @unique
  avatarId               String?                 @unique
  isVerified             Boolean                 @default(false)
  isActive               Boolean                 @default(true)
  role                   UserRole                @default(USER)
  rating                 Decimal                 @default(0) @db.Decimal(3, 2)
  totalRatings           Int                     @default(0)
  refreshTokenVersion    Int                     @default(0)
  region                 String?
  city                   String?
  district               String?
  deletedAt              DateTime?
  deletedBy              String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  fcmToken               String?
  balance                Decimal                 @default(0) @db.Decimal(10, 2)
  publicationCredits     Int                     @default(0)
  birthDate              String?
  country                String?
  gender                 String?
  language               String?
  username               String?                 @unique
  createdAuctions        Auction[]               @relation("AuctionCreator")
  wonAuctions            Auction[]               @relation("AuctionWinner")
  bids                   Bid[]
  conditionsCreated      Condition[]             @relation("ConditionCreator")
  sizesCreated           Size[]                  @relation("SizeCreator")
  conversationsAsBuyer   Conversation[]          @relation("ConversationBuyer")
  conversationsAsSeller  Conversation[]          @relation("ConversationSeller")
  favorites              Favorite[]
  uploadedFiles          File[]                  @relation("FileUploader")
  sentMessages           Message[]               @relation("MessageSender")
  notificationPreference NotificationPreference?
  notifications          Notification[]
  orders                 Order[]
  payments               Payment[]               @relation("PaymentUser")
  products               Product[]
  receivedReviews        Review[]                @relation("Reviewee")
  reviews                Review[]                @relation("Reviewer")
  avatar                 File?                   @relation("UserAvatar", fields: [avatarId], references: [id])
  verificationCodes      VerificationCode[]

  @@unique([countryCode, phoneNumber])
  @@index([phoneNumber])
  @@index([countryCode, phoneNumber])
  @@index([username])
  @@index([email])
  @@index([isActive, deletedAt])
  @@index([isActive, role])
  @@index([role])
  @@index([region])
  @@index([city])
  @@index([region, city])
  @@map("users")
}

model VerificationCode {
  id           String              @id @default(uuid())
  countryCode  String
  phoneNumber  String
  code         String             @db.VarChar(6)
  purpose      VerificationPurpose @default(SIGNUP)
  expiresAt    DateTime
  isUsed       Boolean            @default(false)
  attempts     Int                @default(0)
  maxAttempts  Int                @default(3)
  userId       String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  deletedAt    DateTime?
  deletedBy    String?
  isActive     Boolean            @default(true)
  user         User?              @relation(fields: [userId], references: [id])

  @@index([countryCode, phoneNumber, code, isUsed])
  @@index([countryCode, phoneNumber, expiresAt, isUsed])
  @@index([countryCode, phoneNumber, purpose])
  @@index([isActive, deletedAt])
  @@index([expiresAt])
  @@map("verification_codes")
}

model Conversation {
  id                  String    @id @default(uuid())
  sellerId            String
  buyerId             String
  orderId             String?
  productId           String?
  lastMessageAt       DateTime?
  lastMessageId       String?
  unreadCountBySeller Int       @default(0)
  unreadCountByBuyer  Int       @default(0)
  isArchivedBySeller  Boolean   @default(false)
  isArchivedByBuyer   Boolean   @default(false)
  isBlockedBySeller   Boolean   @default(false)
  isBlockedByBuyer    Boolean   @default(false)
  sellerLastSeenAt    DateTime?
  buyerLastSeenAt     DateTime?
  metadata            Json?
  deletedAt           DateTime?
  deletedBy           String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  isActive            Boolean   @default(true)
  buyer               User      @relation("ConversationBuyer", fields: [buyerId], references: [id], onDelete: Cascade)
  lastMessage         Message?  @relation("ConversationLastMessage", fields: [lastMessageId], references: [id])
  order               Order?    @relation(fields: [orderId], references: [id])
  product             Product?  @relation(fields: [productId], references: [id])
  seller              User      @relation("ConversationSeller", fields: [sellerId], references: [id], onDelete: Cascade)
  messages            Message[]

  @@unique([sellerId, buyerId, orderId])
  @@unique([sellerId, buyerId, productId])
  @@index([sellerId, isArchivedBySeller, lastMessageAt])
  @@index([buyerId, isArchivedByBuyer, lastMessageAt])
  @@index([sellerId, deletedAt])
  @@index([buyerId, deletedAt])
  @@index([orderId])
  @@index([productId])
  @@index([lastMessageAt])
  @@index([isActive, deletedAt])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("conversations")
}

model Message {
  id                        String         @id @default(uuid())
  conversationId            String
  senderId                  String
  replyToMessageId          String?
  messageType               MessageType    @default(TEXT)
  content                   String
  fileId                    String?
  deliveryStatus            DeliveryStatus @default(SENT)
  isRead                    Boolean        @default(false)
  readAt                    DateTime?
  isEdited                  Boolean        @default(false)
  editedAt                  DateTime?
  isDeleted                 Boolean        @default(false)
  deletedAt                 DateTime?
  deletedBy                 String?
  metadata                  Json?
  createdAt                 DateTime       @default(now())
  updatedAt                 DateTime       @updatedAt
  conversationAsLastMessage Conversation[] @relation("ConversationLastMessage")
  conversation              Conversation   @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  file                      File?          @relation("MessageFile", fields: [fileId], references: [id])
  replyTo                   Message?       @relation("MessageReplies", fields: [replyToMessageId], references: [id])
  replies                   Message[]      @relation("MessageReplies")
  sender                    User           @relation("MessageSender", fields: [senderId], references: [id])

  @@index([conversationId, createdAt])
  @@index([conversationId, isDeleted, createdAt])
  @@index([senderId])
  @@index([conversationId])
  @@index([replyToMessageId])
  @@index([isRead])
  @@index([isDeleted, deletedAt])
  @@index([deliveryStatus])
  @@index([createdAt])
  @@index([fileId])
  @@map("messages")
}

model PublicationPricing {
  id           String   @id @default(uuid())
  pricePerPost Decimal  @db.Decimal(10, 2)
  currency     String   @default("UZS")
  isActive     Boolean  @default(true)
  description  String?
  updatedBy    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("publication_pricing")
}

enum AuctionStatus {
  ACTIVE
  CANCELLED
  ENDED
  PENDING
}

enum EntityType {
  CATEGORY_IMAGE
  ORDER_DOCUMENT
  PRODUCT_IMAGE
  REVIEW_IMAGE
  USER_AVATAR
  MESSAGE_ATTACHMENT
}

enum FileType {
  AUDIO
  DOCUMENT
  IMAGE
  OTHER
  VIDEO
}

enum NotificationType {
  AUCTION_ENDING_SOON
  AUCTION_ENDED
  AUCTION_STARTED
  NEW_BID
  ORDER_CONFIRMED
  ORDER_DELIVERED
  ORDER_SHIPPED
  OUTBID
  REVIEW_RECEIVED
  SYSTEM
}

enum OrderStatus {
  CANCELLED
  CONFIRMED
  DELIVERED
  PENDING
  PROCESSING
  SHIPPED
}

enum PaymentType {
  PUBLICATION
  TOP_UP
}

enum PaymentMethod {
  BANK_TRANSFER
  CARD
  CASH_ON_DELIVERY
  MOBILE_PAYMENT
}

enum PaymentGateway {
  CLICK
  PAYME
}

enum PaymentStatus {
  COMPLETED
  FAILED
  PENDING
  PROCESSING
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  PENDING
  SOLD
}

enum ProductType {
  FRESH
  RESALE
}

enum UserRole {
  ADMIN
  MODERATOR
  USER
}

enum VerificationPurpose {
  LOGIN
  SIGNUP
  PHONE_CHANGE
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

enum DeliveryStatus {
  SENT
  DELIVERED
  READ
}
